# Migration `20200423100934-upgrade-old-schema-to-prisma-v2`

This migration has been generated by Yan Takushevich at 4/23/2020, 10:09:34 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "VoteType" AS ENUM ('UP', 'DOWN');

CREATE TYPE "Complexity" AS ENUM ('ELEMENTARY', 'BASIC', 'ADVANCED', 'EXPERT');

CREATE TABLE "public"."Video" (
    "complexity" "Complexity" NOT NULL ,
    "languageId" integer  NOT NULL ,
    "snippet" text  NOT NULL ,
    "uploaderId" text  NOT NULL ,
    "voteScore" integer   DEFAULT 0,
    "ytId" text  NOT NULL ,
    PRIMARY KEY ("ytId")
) 

CREATE TABLE "public"."Vote" (
    "id" SERIAL,
    "parentId" text  NOT NULL ,
    "type" "VoteType" NOT NULL ,
    "userId" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Topic" (
    "id" SERIAL,
    "text" text  NOT NULL ,
    "value" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Tag" (
    "id" SERIAL,
    "text" text  NOT NULL ,
    "value" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Language" (
    "id" SERIAL,
    "text" text  NOT NULL ,
    "value" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."_TopicToVideo" (
    "A" integer  NOT NULL ,
    "B" text  NOT NULL 
) 

CREATE TABLE "public"."_TagToVideo" (
    "A" integer  NOT NULL ,
    "B" text  NOT NULL 
) 

CREATE TABLE "public"."_UserBookmarks" (
    "A" text  NOT NULL ,
    "B" text  NOT NULL 
) 

ALTER TABLE "public"."Post" DROP CONSTRAINT IF EXiSTS "Post_authorId_fkey";

CREATE UNIQUE INDEX "Topic.value" ON "public"."Topic"("value")

CREATE UNIQUE INDEX "Topic.text" ON "public"."Topic"("text")

CREATE UNIQUE INDEX "Tag.value" ON "public"."Tag"("value")

CREATE UNIQUE INDEX "Tag.text" ON "public"."Tag"("text")

CREATE UNIQUE INDEX "Language.value" ON "public"."Language"("value")

CREATE UNIQUE INDEX "Language.text" ON "public"."Language"("text")

CREATE UNIQUE INDEX "_TopicToVideo_AB_unique" ON "public"."_TopicToVideo"("A","B")

CREATE  INDEX "_TopicToVideo_B_index" ON "public"."_TopicToVideo"("B")

CREATE UNIQUE INDEX "_TagToVideo_AB_unique" ON "public"."_TagToVideo"("A","B")

CREATE  INDEX "_TagToVideo_B_index" ON "public"."_TagToVideo"("B")

CREATE UNIQUE INDEX "_UserBookmarks_AB_unique" ON "public"."_UserBookmarks"("A","B")

CREATE  INDEX "_UserBookmarks_B_index" ON "public"."_UserBookmarks"("B")

ALTER TABLE "public"."Video" ADD FOREIGN KEY ("languageId")REFERENCES "public"."Language"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Video" ADD FOREIGN KEY ("uploaderId")REFERENCES "public"."User"("uid") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Vote" ADD FOREIGN KEY ("parentId")REFERENCES "public"."Video"("ytId") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Vote" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("uid") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_TopicToVideo" ADD FOREIGN KEY ("A")REFERENCES "public"."Topic"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_TopicToVideo" ADD FOREIGN KEY ("B")REFERENCES "public"."Video"("ytId") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_TagToVideo" ADD FOREIGN KEY ("A")REFERENCES "public"."Tag"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_TagToVideo" ADD FOREIGN KEY ("B")REFERENCES "public"."Video"("ytId") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_UserBookmarks" ADD FOREIGN KEY ("A")REFERENCES "public"."User"("uid") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_UserBookmarks" ADD FOREIGN KEY ("B")REFERENCES "public"."Video"("ytId") ON DELETE CASCADE  ON UPDATE CASCADE

DROP TABLE "public"."Post";
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200414132300-update-uid-type..20200423100934-upgrade-old-schema-to-prisma-v2
--- datamodel.dml
+++ datamodel.dml
@@ -3,20 +3,70 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("DATABASE_URL")
 }
-model Post {
-  id        Int     @default(autoincrement()) @id
-  title     String
-  content   String?
-  published Boolean @default(false)
-  author    User?   @relation(fields: [authorId], references: [uid])
-  authorId  String?
+model Video {
+  ytId        String     @id
+  snippet     String
+  language    Language   @relation(fields: [languageId], references: [id])
+  languageId  Int
+  complexity  Complexity
+  topics      Topic[]    @relation(references: [id])
+  tags        Tag[]      @relation(references: [id])
+  bookmarkers User[]     @relation("UserBookmarks", references: [uid])
+  votes       Vote[]
+  voteScore   Int?       @default(0)
+  uploader    User       @relation("UserVideos", fields: [uploaderId], references: [uid])
+  uploaderId  String
 }
 model User {
-  uid   String @id
-  posts Post[]
+  uid       String  @id
+  videos    Video[] @relation("UserVideos")
+  bookmarks Video[] @relation("UserBookmarks")
+  votes     Vote[]
+}
+
+model Vote {
+  id       Int      @default(autoincrement()) @id
+  parent   Video    @relation(fields: [parentId], references: [ytId])
+  parentId String
+  user     User     @relation(fields: [userId], references: [uid])
+  userId   String
+  type     VoteType
+}
+
+enum VoteType {
+  UP
+  DOWN
+}
+
+model Topic {
+  id     Int     @default(autoincrement()) @id
+  value  String  @unique
+  text   String  @unique
+  videos Video[] @relation(references: [ytId])
+}
+
+model Tag {
+  id     Int     @default(autoincrement()) @id
+  value  String  @unique
+  text   String  @unique
+  videos Video[] @relation(references: [ytId])
+}
+
+model Language {
+  id     Int     @default(autoincrement()) @id
+  value  String  @unique
+  text   String  @unique
+  parent Video[]
+}
+
+enum Complexity {
+  ELEMENTARY
+  BASIC
+  ADVANCED
+  EXPERT
 }
```


